{{define "page.onboarding.need.documents"}}
{{template "header" .}}

<div class="mx-auto w-full max-w-5xl px-4 py-10 md:px-6">
  <div class="mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm font-semibold uppercase tracking-wide text-[color:var(--cj-accent)]">Person in Need</p>
      <h1 class="text-3xl font-semibold text-foreground">Upload supporting documents</h1>
      <p class="text-muted-foreground">Upload bills, notices, or other documents that support your need.</p>
    </div>
    <div class="w-full max-w-[260px] flex flex-col gap-6 rounded-xl border py-6 shadow-sm">
      <div class="space-y-2 px-6 pb-2">
        <p class="text-sm font-semibold text-foreground">Step 5 of 6</p>
        <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-muted">
          <div class="h-full bg-[color:var(--cj-primary)] transition-all" style="width: 83%"></div>
        </div>
        <p class="mt-2 text-xs text-muted-foreground">Step 5 of 6</p>
      </div>
    </div>
  </div>

  {{if .Notice}}
  <div class="mb-4 rounded-md border border-[color:var(--cj-accent)]/30 bg-[color:var(--cj-accent)]/10 px-4 py-3 text-sm text-foreground">
    {{.Notice}}
  </div>
  {{end}}

  {{if .Error}}
  <div class="mb-4 rounded-md border border-[color:var(--cj-error)] border-l-4 bg-muted px-4 py-3 text-sm font-semibold text-[color:var(--cj-error)]" role="alert">
    {{.Error}}
  </div>
  {{end}}

  <div class="flex flex-col gap-6 rounded-xl border py-6 shadow-sm">

    {{if .Documents}}
    <div class="space-y-3 px-6">
      <p class="text-sm font-semibold text-foreground">Uploaded documents</p>

      <form id="documents-metadata-form" action="/onboarding/need/{{.ID}}/documents/metadata" method="post" class="space-y-4">
        <div class="overflow-x-auto rounded-lg border border-border bg-slate-50">
          <table class="min-w-full divide-y divide-border">
            <thead class="bg-muted/50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground">File Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground">Document Type</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground">Size</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-muted-foreground">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border bg-background">
              {{range .Documents}}
              {{$doc := .}}
              <tr>
                <td class="px-4 py-3 align-top">
                  <input type="hidden" name="document_id" value="{{.ID}}" />
                  <input type="text" name="file_name" value="{{.FileName}}" required
                    class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" />
                </td>
                <td class="px-4 py-3 align-top">
                  <select name="document_type"
                    class="flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-ring">
                    {{range $.DocumentTypeOptions}}
                    <option value="{{.Value}}" {{if eq .Value $doc.DocumentType}}selected{{end}}>{{.Label}}</option>
                    {{end}}
                  </select>
                </td>
                <td class="px-4 py-3 align-top text-sm text-muted-foreground">
                  {{div .FileSizeBytes 1024}} KB
                </td>
                <td class="px-4 py-3 align-top">
                  <button type="submit" formaction="/onboarding/need/{{$.ID}}/documents/{{$doc.ID}}/delete" formmethod="post" formnovalidate
                    class="inline-flex h-9 items-center justify-center whitespace-nowrap rounded-md border border-[color:var(--cj-error)]/30 bg-[color:var(--cj-error)]/10 px-3 py-2 text-xs font-medium text-[color:var(--cj-error)] transition-all hover:bg-[color:var(--cj-error)]/20">
                    Remove
                  </button>
                </td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>

        <div class="flex flex-col items-center justify-center gap-2">
          <button id="metadata-submit-button" type="submit"
            class="inline-flex h-9 items-center justify-center gap-2 whitespace-nowrap rounded-md border border-border bg-background px-4 py-2 text-sm font-medium shadow-sm transition-all hover:bg-accent hover:text-accent-foreground">
            Update Document Metadata
          </button>
          <p id="metadata-feedback" class="hidden text-sm font-medium text-[color:var(--cj-accent)]" aria-live="polite">Updating document metadata...</p>
        </div>
      </form>
    </div>
    {{end}}

    <form id="documents-upload-form" action="/onboarding/need/{{.ID}}/documents/upload" method="post" enctype="multipart/form-data" class="space-y-4 px-6">
      <div class="rounded-xl border-2 border-dashed border-border bg-slate-50 p-8 text-center">
        <input type="file" name="documents" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden" id="file-upload" />
        <label for="file-upload" class="cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
          </svg>
          <p class="mt-2 text-sm font-semibold text-foreground">Click to upload or drag and drop</p>
          <p class="mt-1 text-xs text-muted-foreground">PDF, JPG, PNG up to 10MB each</p>
        </label>

        <div id="selected-files" class="mt-4 hidden rounded-md border border-border bg-background p-3 text-left">
          <p id="selected-files-count" class="text-xs font-semibold uppercase tracking-wide text-muted-foreground"></p>
          <ul id="selected-files-list" class="mt-2 space-y-1 text-sm text-foreground"></ul>
        </div>
      </div>


      <div class="flex flex-col items-center justify-center gap-2">
        <button id="upload-submit-button" type="submit"
          class="inline-flex h-9 items-center justify-center gap-2 whitespace-nowrap rounded-md border border-border bg-background px-4 py-2 text-sm font-medium shadow-sm transition-all hover:bg-accent hover:text-accent-foreground">
          Upload
        </button>
        <p id="upload-feedback" class="hidden text-sm font-medium text-[color:var(--cj-accent)]" aria-live="polite">Uploading documents...</p>
      </div>
      <div class="rounded-xl border border-border bg-slate-50 p-4 text-sm text-muted-foreground">
        <p class="font-semibold text-foreground">What to upload</p>
        <ul class="mt-2 list-disc space-y-1 pl-4">
          <li>Eviction notice or past-due rent statement</li>
          <li>Utility bills or shut-off notices</li>
          <li>Medical bills or prescriptions</li>
          <li>Pay stubs or proof of income loss</li>
        </ul>
      </div>

    </form>
  </div>

  <div class="mt-6 flex items-center justify-between">
    <a href="/onboarding/need/{{.ID}}/story"
      class="inline-flex h-9 items-center justify-center gap-2 whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium transition-all hover:bg-accent hover:text-accent-foreground">
      Back
    </a>

    <form id="documents-continue-form" action="/onboarding/need/{{.ID}}/documents" method="post" class="flex items-center gap-3">
      {{if not .HasDocuments}}
      <label for="skip-documents-checkbox" class="inline-flex items-center gap-2 text-sm text-muted-foreground">
        <input id="skip-documents-checkbox" name="skipDocuments" type="checkbox" class="h-4 w-4 rounded border-border text-[color:var(--cj-primary)] focus:ring-[color:var(--cj-primary)]" />
        Continue without documents for now
      </label>
      {{end}}
      <button id="continue-button" type="submit" {{if not .HasDocuments}}disabled{{end}}
        class="inline-flex h-9 items-center justify-center gap-2 whitespace-nowrap rounded-md bg-[color:var(--cj-primary)] px-4 py-2 text-sm font-medium text-white transition-all hover:bg-[color:var(--cj-primary)]/90 {{if not .HasDocuments}}cursor-not-allowed opacity-60{{end}}">
        Continue
      </button>
    </form>
  </div>
</div>

<script>
  (function () {
    var fileInput = document.getElementById('file-upload')
    var uploadForm = document.getElementById('documents-upload-form')
    var uploadSubmitButton = document.getElementById('upload-submit-button')
    var uploadFeedback = document.getElementById('upload-feedback')
    var metadataForm = document.getElementById('documents-metadata-form')
    var metadataSubmitButton = document.getElementById('metadata-submit-button')
    var metadataFeedback = document.getElementById('metadata-feedback')
    var continueButton = document.getElementById('continue-button')
    var skipDocumentsCheckbox = document.getElementById('skip-documents-checkbox')
    var selectedFilesContainer = document.getElementById('selected-files')
    var selectedFilesCount = document.getElementById('selected-files-count')
    var selectedFilesList = document.getElementById('selected-files-list')

    if (fileInput && uploadForm && uploadSubmitButton && uploadFeedback && selectedFilesContainer && selectedFilesCount && selectedFilesList) {
      fileInput.addEventListener('change', function () {
        var files = fileInput.files
        if (!files || files.length === 0) {
          selectedFilesContainer.classList.add('hidden')
          selectedFilesList.innerHTML = ''
          selectedFilesCount.textContent = ''
          return
        }

        selectedFilesContainer.classList.remove('hidden')
        selectedFilesCount.textContent = files.length + (files.length === 1 ? ' file selected' : ' files selected')
        selectedFilesList.innerHTML = ''

        for (var i = 0; i < files.length; i++) {
          var file = files[i]
          var item = document.createElement('li')
          var sizeKb = Math.max(1, Math.round(file.size / 1024))
          item.textContent = file.name + ' (' + sizeKb + ' KB)'
          selectedFilesList.appendChild(item)
        }
      })

      uploadForm.addEventListener('submit', function () {
        uploadSubmitButton.disabled = true
        uploadSubmitButton.classList.add('opacity-60', 'cursor-not-allowed')
        uploadSubmitButton.textContent = 'Uploading...'
        uploadFeedback.classList.remove('hidden')
      })
    }

    if (continueButton && skipDocumentsCheckbox) {
      skipDocumentsCheckbox.addEventListener('change', function () {
        var enabled = skipDocumentsCheckbox.checked
        continueButton.disabled = !enabled
        continueButton.classList.toggle('opacity-60', !enabled)
        continueButton.classList.toggle('cursor-not-allowed', !enabled)
      })
    }

    if (metadataForm && metadataSubmitButton && metadataFeedback) {
      metadataForm.addEventListener('submit', function (event) {
        var submitter = event.submitter
        if (submitter && submitter.getAttribute('formaction') && submitter.getAttribute('formaction').indexOf('/delete') !== -1) {
          submitter.disabled = true
          submitter.classList.add('opacity-60', 'cursor-not-allowed')
          submitter.textContent = 'Removing...'
          return
        }

        metadataSubmitButton.disabled = true
        metadataSubmitButton.classList.add('opacity-60', 'cursor-not-allowed')
        metadataSubmitButton.textContent = 'Updating...'
        metadataFeedback.classList.remove('hidden')
      })
    }
  })()
</script>

{{template "footer" .}}
{{end}}